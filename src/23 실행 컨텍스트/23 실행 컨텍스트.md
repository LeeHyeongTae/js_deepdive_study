# 23. 실행 컨텍스트

- 자바스크립트의 동작 원리를 담고 있는 핵심 개념.
- 스코프를 기반으로 식별자와 식별자에 바인딩된 값을 관리하는 방식.
- 호이스팅이 발생하는 이유
- 클로저의 동작 방식
- 태스크 큐와 함께 동작하는 이벤트 핸들러
- 비동기 처리의 동작 방식

## 23-1. 소스코드 타입

- ECMAScript는 소스코드를 4가지 타입으로 구분. 소스코드는 실행 컨텍스트를 생성.


| 소스코드의 타입 | 설명 |
|:-----------:|:------------------------------------------------------------:|
|global code|전역에 존재하는 소스코드, 전역에 정의된 함수, 클래스 등의 내부 코드는 포함되지 않음.|
|function code | 함수 내부에 존재하는 소스코드. 함수 내부에 중첩된 함수, 클래스 등의 내부코드는 포함되지 않는다.|
|eval code | 빌트인 전역 함수인 eval 함수에 argument로 전달되어 실행되는 소스코드|
|module code | 모둘 내부에 존재하는 소스코드, 모듈 내부의 함수, 클래스 등의 내부코드는 포함되지 않는다.|

> 소스코드를 4가지 타입으로 구분하는 이유는 소스코드의 타입에 따라 실행 컨텍스트를 생성하는 과정과 관리 내용이 다르기 때문

1. 전역코드
  - 전역 변수를 관리하기 위해 최상위 스코프인 전역 스코프를 생성
  - var 키워드로 선언된 전역 변수와 함수 선언문으로 정의된 전역 함수를 전역 객체의 프로퍼티와 메서드로 바인딩하고 참조하기 위해 전역 객체와 연결
  - 전역 코드가 평가되면 전역 실행 컨텍스트가 생성
2. 함수 코드
  - 지역 스코프를 생성하고 지역 변수, 매개변수, arguments 객체를 관리
  - 생성한 지역 스코프를 전역 스코프에서 시작하는 스코프 체인의 일원으로 연결
  - 함수 코드가 평가되면 함수 실행 컨텍스트가 생성
3. eval 코드
  - strict mode에서 자신만의 독자적인 스코프를 생성
  - 코드가 평가되면 eval 실행 컨텍스트가 생성
4. module code
  - 모듈별로 독립적인 모듈 스코프를 생성
  - 모듈 코드가 평가되면 모듈 실행 컨택스트가 생성

```mermaid
flowchart LR
  code1[global code]
  code2[function code]
  code3[eval code]
  code4[module code]
  cont1[전역 실행 컨텍스트]
  cont2[함수 실행 컨텍스트]
  cont3[eval 실행 컨텍스트]
  cont4[모듈 실행 컨텍스트]
  
  code1 ---> cont1
  code2 ---> cont2
  code3 ---> cont3
  code4 ---> cont4
 ```
 
## 23-2. 소스코드의 평가와 실행

> 모든 소스코드는 실행에 앞서 평가 과정을 거치며 코드를 실행하기 위한 준비를 한다.  
> 자바스크립트 엔진은 '소스코드의 평가'와 '소스코드의 실행'과정으로 나누어 처리한다.

```mermaid
flowchart LR
  code1[1. 소스코드의 평가 '선언문']
  cont[실행 컨텍스트]
  code2[2. 소스코드의 실행  '선언문 이외의 문']
  
  code1 --->|평가 결과| cont
  cont --->|실행에 필요한 정보| code2
  code2 --->|실행 결과| cont
```

> 1. 평가 과정에서 실행 컨텍스트를 생성하고 변수, 함수 등의 선언문만 먼저 실행하여 생성된 변수나 함수 식별자를 키로 실행 컨텍스트가 관리하는 스코프(렉시컬 환경의 환경 레코드)에 등록  
> 2. 평가 과정이 끝나면 소스코드가 순차적으로 실행  
> 3. 소스코드 실행에 필요한 정보(변수나 함수)의 참조를 실행 컨텍스트가 관리하는 스코프에서 검색해 취득  
> 4. 변수 값의 변경 등 소스코드의 실행 결과는 다시 실행 컨텍스트가 관리하는 스코프에 등록

```
var x;
// 1. 소스코드 평가 과정에서 변수 선언문을 먼저 실행
// 2. 생성된 변수 식별자 x는 실행 컨텍스트가 관리하는 스코프에 등록되고 undifined로 초기화
x = 1; // 3. 평가 과정이 끝나면 소스코드 실행 과정 시작.
// 4. 실행과정에서는 변수 할당문 x = 1;만 실행
// 5. 변수 x가 선언되어있는지 확인하기 위해 실행 컨텍스트를 검색
// 6. 선언된 변수라면 값을 할당하고 할당 결과를 실행 컨텍스트에 등록하여 관리
```

## 23-3. 실행 컨텍스트의 역할

- 실행 컨텍스트는 소스코드를 실행하는 데 필요한 환경을 제공하고 코드의 실행 결과를 실제로 관리하는 영역
- 식별자(변수, 함수, 클래스 등의 이름)를 등록하고 관리하는 스코프와 코드 실행 순서 관리를 구현한 내부 메커니즘.
- 모든 코드는 실행 컨텍스트를 통해 실행되고 관리
- 식별자와 스코프는 실행 컨텍스트의 렉시컬 환경으로 관리
- 코드 실행 순서는 싱행 컨텍스트 스택으로 관리

```
// 전역 변수 선언
const x = 1;
const y = 2;

// 함수 정의
function foo(a) {
  // 지역변수 선언
  const x = 10;
  const y = 20;
  
  // 메서드 호출
  console.log(a + x + y); // 130
}

// 함수 호출
foo(100);

// 메서드 호출
console.log(x + y); // 3

```

1. 전역 코드 평가
  - 전역 코드의 변수 선언문과 함수선언문이 먼저 실행.
  - 생성된 전역 변수와 전역 함수가 실행 컨텍스트가 관리하는 전역 스코프에 등록.
  - var키워드로 선언된 전역변수, 함수선언문으로 정의된 전역함수는 전역 객체의 프로퍼티와 메서드가 됨.

2. 전역 코드 실행
  - 평가 과정이 끝나면 런타임이 시작, 전역 코드가 순차적으로 실행.
  - 전역 변수에 값이 할당, 함수가 호출됨.
  - 함수가 호출되면 전역 코드의 실행을 일시 중단하고 코드 실행 순서를 변경하여 함수 내부로 진입.
3. 함수 코드 평가
  - 함수 내부 진입 시 내부의 함수 코드 평가 과정을 거침
  - 매개변수와 지역 변수 선언문이 먼저 실행
  - 생성된 매개변수와 지역변수가 실행 컨텍스트가 관리하는 지역 스코프에 등록
  - 함수 내부에서 지역 변수처럼 사용가능한 arguments 객체 생성되어 지역스코프에 등록
  - this 바인딩 결정

4. 함수 코드 실행
  - 코드 평가가 끝나면 런타임 시작, 함수 코드가 순차적 실행.
  - 매개변수와 지역 변수에 값이 할당.
  - console.log 메서드를 호출하기 위해 식별자인 console을 스코프 체인을 통해 검색
  - 함수 코드의 스코프가 상위의 전역 스코프와 연결되어야 함.
  - console 식별자는 전역 객체에 프로퍼티로 존재함.
  - 전역 객체의 프로퍼티가 전역변수 처럼 스코프를 통해 검색 가능해야 함.
  - log프로퍼티를 console객체의 프로토타입 체인을 통해 검색
  - 인수로 전달된 a + x + y표현식이 평가
  - 각 식별자는 스코프 체인을 통해 검색
  - 실행이 종료되면 함수호출 이전으로 되돌아가 전역 코드를 계속 실행

## 23-4. 실행 컨텍스트 스택

```
const x = 1;

function foo() {
  const y = 2;
  
  function bar() {
    const z = 3;
    console.log(x + y + z);
  }
  bar();
}

foo(); // 6
```

- 생성된 실행 컨텍스트는 스택(stack) 자료구조로 관리됨.
- 실행 컨텍스트 스택이라고 부름
- 시간의 흐름에 따라 추가(push)되고 제거(pop)된다

## 23-5. 렉시컬 환경

